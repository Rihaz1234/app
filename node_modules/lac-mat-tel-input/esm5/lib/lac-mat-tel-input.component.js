import { __decorate, __metadata, __param } from "tslib";
import { Component, HostBinding, Input, Optional, Self, ElementRef, ViewChild, EventEmitter, Output, ChangeDetectorRef } from '@angular/core';
import { MatFormFieldControl } from '@angular/material/form-field';
import { MatInput } from '@angular/material/input';
import { Subject } from 'rxjs';
import { NgControl } from '@angular/forms';
import { FocusMonitor } from '@angular/cdk/a11y';
import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { getExampleNumber, parsePhoneNumberFromString, AsYouType, getCountryCallingCode } from 'libphonenumber-js';
import { Examples } from './data/country-code';
var LacMatTelInputComponent = /** @class */ (function () {
    function LacMatTelInputComponent(ngControl, fm, elRef, changeDetector) {
        var _this = this;
        this.ngControl = ngControl;
        this.fm = fm;
        this.elRef = elRef;
        this.changeDetector = changeDetector;
        this.blur = new EventEmitter();
        this.PhoneNumberMaxDigits = 20;
        this.maxInputLength = this.PhoneNumberMaxDigits;
        //Subject to notify when country needs to be update from input
        //Se paste condition in onInputChanged
        this.countryChange = new Subject();
        //Mat Form Field implementation - BEGIN
        this.stateChanges = new Subject();
        this.id = "lac-mat-tel-input-" + LacMatTelInputComponent_1.nextId++;
        //ngControl: NgControl; set with Dependency Injection
        this.focused = false;
        //adds a required indicator to the label/placeholder
        this._required = false;
        this.inputDisabled = false;
        this.controlType = 'mat-tel';
        this.describedBy = '';
        this.onTouched = function () {
        };
        this.propagateChange = function (_) {
        };
        //ControlValueAccessor - END
        this._internationalFormat = false;
        if (this.ngControl != null) {
            // Setting the value accessor directly (instead of using
            // the providers) to avoid running into a circular import.
            this.ngControl.valueAccessor = this;
        }
        fm.monitor(elRef.nativeElement, true).subscribe(function (origin) {
            _this.focused = !!origin;
            _this.stateChanges.next();
        });
    }
    LacMatTelInputComponent_1 = LacMatTelInputComponent;
    Object.defineProperty(LacMatTelInputComponent.prototype, "value", {
        set: function (v) {
            this._value = v ? "+" + getCountryCallingCode(this.selectedCountry) + " " + v : v;
            if (this.internationalFormat && this._value) {
                var phoneNumber = parsePhoneNumberFromString(this._value);
                if (phoneNumber && phoneNumber.isValid()) {
                    this._value = phoneNumber.formatInternational();
                }
            }
            this.propagateChange(this._value);
            this.stateChanges.next();
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(LacMatTelInputComponent.prototype, "placeholder", {
        get: function () {
            return this._placeholder;
        },
        set: function (val) {
            this._placeholder = val;
            this.stateChanges.next();
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(LacMatTelInputComponent.prototype, "empty", {
        get: function () {
            return !this.phone;
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(LacMatTelInputComponent.prototype, "shouldLabelFloat", {
        //shouldLabelFloat: boolean;
        get: function () {
            return this.focused || !this.empty;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LacMatTelInputComponent.prototype, "required", {
        get: function () {
            return this._required;
        },
        set: function (req) {
            this._required = coerceBooleanProperty(req);
            this.stateChanges.next();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LacMatTelInputComponent.prototype, "disabled", {
        get: function () { return this.inputDisabled || this.ngControl.disabled; },
        set: function (value) {
            this.inputDisabled = coerceBooleanProperty(value);
            this.stateChanges.next();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LacMatTelInputComponent.prototype, "errorState", {
        get: function () {
            return this.ngControl && this.ngControl.errors !== null && !!this.ngControl.touched;
        },
        enumerable: true,
        configurable: true
    });
    LacMatTelInputComponent.prototype.setDescribedByIds = function (ids) {
        this.describedBy = ids.join(' ');
    };
    LacMatTelInputComponent.prototype.onContainerClick = function (event) {
        if (!this.disabled) {
            this.onTouched();
        }
    };
    //Mat Form Field implementation - END
    //ControlValueAccessor - BEGIN
    LacMatTelInputComponent.prototype.writeValue = function (value) {
        this.onInputChanged(value);
    };
    LacMatTelInputComponent.prototype.registerOnChange = function (fn) {
        this.propagateChange = fn;
    };
    LacMatTelInputComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    Object.defineProperty(LacMatTelInputComponent.prototype, "internationalFormat", {
        get: function () {
            return this._internationalFormat;
        },
        set: function (format) {
            this._internationalFormat = coerceBooleanProperty(format);
            this.onInputChanged(this.phone);
        },
        enumerable: true,
        configurable: true
    });
    //lifecycle
    LacMatTelInputComponent.prototype.ngOnInit = function () {
    };
    LacMatTelInputComponent.prototype.ngOnDestroy = function () {
        this.fm.stopMonitoring(this.elRef.nativeElement);
        this.countryChange.complete();
        this.stateChanges.complete();
    };
    LacMatTelInputComponent.prototype.onCountrySelected = function (code, noPhoneReset) {
        var _this = this;
        var hasCountryChanged = this.selectedCountry && this.selectedCountry != code;
        this.selectedCountry = code;
        var example = getExampleNumber(code, Examples).formatNational();
        var numbersOnly = example.replace(/[^\d]/g, '');
        var maxExample = numbersOnly + '9999999999';
        this.maxInputLength = this.PhoneNumberMaxDigits;
        //find out the maximum (formatted) size a valid number for the country can have
        for (var i = maxExample.length; i >= 0; i--) {
            var test = maxExample.substring(0, i);
            var testPhone = parsePhoneNumberFromString(test, code);
            if (testPhone && testPhone.isValid()) {
                var maxInput = new AsYouType(code).input(test);
                this.maxInputLength = maxInput.length;
                this.placeholder = maxInput; //TODO set placeholder optionally
                break;
            }
        }
        //when new country is selected reset phone if phone reset was not disabled 
        if (hasCountryChanged && !noPhoneReset) {
            this.phone = '';
            this.value = this.phone;
            //focus on input
            if (this.phoneInput) {
                setTimeout(function () { return _this.phoneInput.focus(); });
            }
        }
    };
    LacMatTelInputComponent.prototype.onInputChanged = function (e) {
        var _this = this;
        if (!e) {
            e = '';
        }
        this.phone = e;
        if (e.startsWith('+')) { //handles pasting of a complete international number
            try {
                var pastedNumber_1 = parsePhoneNumberFromString(e);
                if (pastedNumber_1 && pastedNumber_1.country) {
                    var code = pastedNumber_1.country;
                    this.onCountrySelected(code, true);
                    this.countryChange.next(code);
                    setTimeout(function () {
                        _this.phone = pastedNumber_1.formatNational();
                        _this.value = _this.phone;
                    });
                    return;
                }
            }
            catch (_a) {
            }
        }
        var numbersOnly = e.replace(/[^\d]/g, '');
        setTimeout(function () {
            var formatted = new AsYouType(_this.selectedCountry).input(numbersOnly);
            //if the formatted output equals what we already have then the user is trying to delete a symbol inserted by
            //the formatted version
            _this.phone = formatted.substr(0, formatted.length - 1) === _this.phone ? numbersOnly : formatted;
            _this.value = _this.phone;
        }, 0);
    };
    LacMatTelInputComponent.prototype.onInputKeyPress = function (event) {
        var allowedChars = /[0-9\+\-\ ]/;
        var allowedCtrlChars = /[axcv]/; // Allows copy-pasting
        var allowedOtherKeys = [
            'ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown',
            'Home', 'End', 'Insert', 'Delete', 'Backspace'
        ];
        if (!allowedChars.test(event.key)
            && !(event.ctrlKey && allowedCtrlChars.test(event.key))
            && !(allowedOtherKeys.includes(event.key))) {
            event.preventDefault();
        }
    };
    var LacMatTelInputComponent_1;
    //the id of an element to associate labels and hints with.
    LacMatTelInputComponent.nextId = 0;
    LacMatTelInputComponent.ctorParameters = function () { return [
        { type: NgControl, decorators: [{ type: Optional }, { type: Self }] },
        { type: FocusMonitor },
        { type: ElementRef },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], LacMatTelInputComponent.prototype, "blur", void 0);
    __decorate([
        ViewChild('phoneInput', { static: true }),
        __metadata("design:type", MatInput)
    ], LacMatTelInputComponent.prototype, "phoneInput", void 0);
    __decorate([
        HostBinding(),
        __metadata("design:type", String)
    ], LacMatTelInputComponent.prototype, "id", void 0);
    __decorate([
        HostBinding('class.floating'),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [])
    ], LacMatTelInputComponent.prototype, "shouldLabelFloat", null);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], LacMatTelInputComponent.prototype, "required", null);
    __decorate([
        Input(),
        __metadata("design:type", Boolean),
        __metadata("design:paramtypes", [Boolean])
    ], LacMatTelInputComponent.prototype, "disabled", null);
    __decorate([
        HostBinding('attr.aria-describedby'),
        __metadata("design:type", Object)
    ], LacMatTelInputComponent.prototype, "describedBy", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], LacMatTelInputComponent.prototype, "internationalFormat", null);
    LacMatTelInputComponent = LacMatTelInputComponent_1 = __decorate([
        Component({
            selector: 'lac-mat-tel-input',
            template: "<input type=\"text\" matInput #phoneInput=\"matInput\"\n  [ngModel]=\"phone\"\n  (blur)=\"blur.emit($event)\"\n  (keypress)=\"onInputKeyPress($event)\"\n  (ngModelChange)=\"onInputChanged($event)\"\n  [disabled]=\"disabled\"\n  [maxlength]=\"!phone ? PhoneNumberMaxDigits : maxInputLength\"\n  [placeholder]=\"placeholder\"  />\n",
            providers: [{ provide: MatFormFieldControl, useExisting: LacMatTelInputComponent_1 }],
            styles: [""]
        }),
        __param(0, Optional()), __param(0, Self()),
        __metadata("design:paramtypes", [NgControl,
            FocusMonitor,
            ElementRef,
            ChangeDetectorRef])
    ], LacMatTelInputComponent);
    return LacMatTelInputComponent;
}());
export { LacMatTelInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFjLW1hdC10ZWwtaW5wdXQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbGFjLW1hdC10ZWwtaW5wdXQvIiwic291cmNlcyI6WyJsaWIvbGFjLW1hdC10ZWwtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFOUksT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ25ELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsMEJBQTBCLEVBQUUsU0FBUyxFQUFlLHFCQUFxQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDaEksT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBUS9DO0lBc0lFLGlDQUM2QixTQUFvQixFQUN2QyxFQUFnQixFQUNoQixLQUE4QixFQUM5QixjQUFpQztRQUozQyxpQkFnQkM7UUFmNEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUN2QyxPQUFFLEdBQUYsRUFBRSxDQUFjO1FBQ2hCLFVBQUssR0FBTCxLQUFLLENBQXlCO1FBQzlCLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQXhJM0MsU0FBSSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FB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bUI7WUFDN0IscVZBQWlEO1lBRWpELFNBQVMsRUFBRSxDQUFDLEVBQUMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFdBQVcsRUFBRSx5QkFBdUIsRUFBQyxDQUFDOztTQUNsRixDQUFDO1FBd0lHLFdBQUEsUUFBUSxFQUFFLENBQUEsRUFBRSxXQUFBLElBQUksRUFBRSxDQUFBO3lDQUFtQixTQUFTO1lBQ25DLFlBQVk7WUFDVCxVQUFVO1lBQ0QsaUJBQWlCO09BMUloQyx1QkFBdUIsQ0E0UG5DO0lBQUQsOEJBQUM7Q0FBQSxBQTVQRCxJQTRQQztTQTVQWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEhvc3RCaW5kaW5nLCBJbnB1dCwgT3B0aW9uYWwsIFNlbGYsIEVsZW1lbnRSZWYsIFZpZXdDaGlsZCwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgdHlwZSB7IE9uSW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXRGb3JtRmllbGRDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZm9ybS1maWVsZCc7XG5pbXBvcnQgeyBNYXRJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2lucHV0JztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE5nQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEZvY3VzTW9uaXRvciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQgeyBnZXRFeGFtcGxlTnVtYmVyLCBwYXJzZVBob25lTnVtYmVyRnJvbVN0cmluZywgQXNZb3VUeXBlLCBDb3VudHJ5Q29kZSwgZ2V0Q291bnRyeUNhbGxpbmdDb2RlIH0gZnJvbSAnbGlicGhvbmVudW1iZXItanMnO1xuaW1wb3J0IHsgRXhhbXBsZXMgfSBmcm9tICcuL2RhdGEvY291bnRyeS1jb2RlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbGFjLW1hdC10ZWwtaW5wdXQnLFxuICB0ZW1wbGF0ZVVybDogJy4vbGFjLW1hdC10ZWwtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9sYWMtbWF0LXRlbC1pbnB1dC5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFt7cHJvdmlkZTogTWF0Rm9ybUZpZWxkQ29udHJvbCwgdXNlRXhpc3Rpbmc6IExhY01hdFRlbElucHV0Q29tcG9uZW50fV1cbn0pXG5leHBvcnQgY2xhc3MgTGFjTWF0VGVsSW5wdXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgTWF0Rm9ybUZpZWxkQ29udHJvbDxzdHJpbmc+IHtcbiAgQE91dHB1dCgpXG4gIGJsdXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgUGhvbmVOdW1iZXJNYXhEaWdpdHM6IG51bWJlciA9IDIwO1xuXG4gIHBob25lOiBzdHJpbmc7XG4gIEBWaWV3Q2hpbGQoJ3Bob25lSW5wdXQnLCB7IHN0YXRpYzogdHJ1ZSB9KSBwaG9uZUlucHV0OiBNYXRJbnB1dDtcblxuICBtYXhJbnB1dExlbmd0aDogbnVtYmVyID0gdGhpcy5QaG9uZU51bWJlck1heERpZ2l0cztcblxuICAvL1N1YmplY3QgdG8gbm90aWZ5IHdoZW4gY291bnRyeSBuZWVkcyB0byBiZSB1cGRhdGUgZnJvbSBpbnB1dFxuICAvL1NlIHBhc3RlIGNvbmRpdGlvbiBpbiBvbklucHV0Q2hhbmdlZFxuICBjb3VudHJ5Q2hhbmdlID0gbmV3IFN1YmplY3Q8Q291bnRyeUNvZGU+KCk7XG4gIFxuICBwcml2YXRlIHNlbGVjdGVkQ291bnRyeTogQ291bnRyeUNvZGU7XG5cbiAgLy9NYXQgRm9ybSBGaWVsZCBpbXBsZW1lbnRhdGlvbiAtIEJFR0lOXG4gIHN0YXRlQ2hhbmdlcyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgLy90aGUgdmFsdWUgb2YgdGhlIEZvcm1GaWVsZENvbnRyb2xcbiAgX3ZhbHVlOiBzdHJpbmc7XG4gIHNldCB2YWx1ZSh2OiBzdHJpbmcgfCBudWxsKSB7Ly93aGVuZXZlciB2YWx1ZSBjaGFuZ2VzIC0+IHRoaXMuc3RhdGVDaGFuZ2VzLm5leHQoKTsgc28gZm9ybS1maWVsZCBydW5zIGNoYW5nZSBkZXRlY3Rpb25cbiAgICB0aGlzLl92YWx1ZSA9ICB2ID8gYCske2dldENvdW50cnlDYWxsaW5nQ29kZSh0aGlzLnNlbGVjdGVkQ291bnRyeSl9ICR7dn1gIDogdjtcbiAgICBpZiAodGhpcy5pbnRlcm5hdGlvbmFsRm9ybWF0ICYmIHRoaXMuX3ZhbHVlKSB7XG4gICAgICBsZXQgcGhvbmVOdW1iZXIgPSBwYXJzZVBob25lTnVtYmVyRnJvbVN0cmluZyh0aGlzLl92YWx1ZSk7XG5cbiAgICAgIGlmIChwaG9uZU51bWJlciAmJiBwaG9uZU51bWJlci5pc1ZhbGlkKCkpIHtcbiAgICAgICAgdGhpcy5fdmFsdWUgPSBwaG9uZU51bWJlci5mb3JtYXRJbnRlcm5hdGlvbmFsKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucHJvcGFnYXRlQ2hhbmdlKHRoaXMuX3ZhbHVlKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlcy5uZXh0KCk7XG4gIH07XG5cbiAgLy90aGUgaWQgb2YgYW4gZWxlbWVudCB0byBhc3NvY2lhdGUgbGFiZWxzIGFuZCBoaW50cyB3aXRoLlxuICBzdGF0aWMgbmV4dElkID0gMDtcbiAgQEhvc3RCaW5kaW5nKCkgaWQ6IHN0cmluZyA9IGBsYWMtbWF0LXRlbC1pbnB1dC0ke0xhY01hdFRlbElucHV0Q29tcG9uZW50Lm5leHRJZCsrfWA7XG5cbiAgLy9wbGFjZWhvbGRlclxuICBwcml2YXRlIF9wbGFjZWhvbGRlcjogc3RyaW5nO1xuXG4gIGdldCBwbGFjZWhvbGRlcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9wbGFjZWhvbGRlcjtcbiAgfTtcbiAgc2V0IHBsYWNlaG9sZGVyKHZhbCkge1xuICAgIHRoaXMuX3BsYWNlaG9sZGVyID0gdmFsO1xuICAgIHRoaXMuc3RhdGVDaGFuZ2VzLm5leHQoKTtcbiAgfVxuXG4gIC8vbmdDb250cm9sOiBOZ0NvbnRyb2w7IHNldCB3aXRoIERlcGVuZGVuY3kgSW5qZWN0aW9uXG5cbiAgZm9jdXNlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGdldCBlbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMucGhvbmU7XG4gIH07XG5cbiAgLy9zaG91bGRMYWJlbEZsb2F0OiBib29sZWFuO1xuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmZsb2F0aW5nJylcbiAgZ2V0IHNob3VsZExhYmVsRmxvYXQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZm9jdXNlZCB8fCAhdGhpcy5lbXB0eTtcbiAgfVxuXG4gIC8vYWRkcyBhIHJlcXVpcmVkIGluZGljYXRvciB0byB0aGUgbGFiZWwvcGxhY2Vob2xkZXJcbiAgcHJpdmF0ZSBfcmVxdWlyZWQgPSBmYWxzZTtcbiAgQElucHV0KClcbiAgZ2V0IHJlcXVpcmVkKCkge1xuICAgIHJldHVybiB0aGlzLl9yZXF1aXJlZDtcbiAgfVxuICBzZXQgcmVxdWlyZWQocmVxKSB7XG4gICAgdGhpcy5fcmVxdWlyZWQgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkocmVxKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlcy5uZXh0KCk7XG4gIH1cblxuICBwcml2YXRlIGlucHV0RGlzYWJsZWQgPSBmYWxzZTtcbiAgQElucHV0KClcbiAgZ2V0IGRpc2FibGVkKCk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5pbnB1dERpc2FibGVkIHx8IHRoaXMubmdDb250cm9sLmRpc2FibGVkOyB9XG4gIHNldCBkaXNhYmxlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuaW5wdXREaXNhYmxlZCA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSh2YWx1ZSk7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICB9XG5cbiAgZ2V0IGVycm9yU3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMubmdDb250cm9sICYmIHRoaXMubmdDb250cm9sLmVycm9ycyAhPT0gbnVsbCAmJiAhIXRoaXMubmdDb250cm9sLnRvdWNoZWQ7XG4gIH1cblxuICBjb250cm9sVHlwZT86IHN0cmluZyA9ICdtYXQtdGVsJztcblxuICBhdXRvZmlsbGVkPzogYm9vbGVhbjtcblxuXG4gIEBIb3N0QmluZGluZygnYXR0ci5hcmlhLWRlc2NyaWJlZGJ5JykgZGVzY3JpYmVkQnkgPSAnJztcbiAgc2V0RGVzY3JpYmVkQnlJZHMoaWRzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIHRoaXMuZGVzY3JpYmVkQnkgPSBpZHMuam9pbignICcpO1xuICB9XG5cbiAgb25Db250YWluZXJDbGljayhldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xuICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICB9XG4gIH1cbiAgLy9NYXQgRm9ybSBGaWVsZCBpbXBsZW1lbnRhdGlvbiAtIEVORFxuXG4gIC8vQ29udHJvbFZhbHVlQWNjZXNzb3IgLSBCRUdJTlxuICB3cml0ZVZhbHVlKHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLm9uSW5wdXRDaGFuZ2VkKHZhbHVlKTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSk6IHZvaWQge1xuICAgIHRoaXMucHJvcGFnYXRlQ2hhbmdlID0gZm47XG4gIH1cblxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KSB7XG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcbiAgfVxuXG4gIG9uVG91Y2hlZCA9ICgpID0+IHtcbiAgfVxuXG4gIHByb3BhZ2F0ZUNoYW5nZSA9IChfOiBhbnkpID0+IHtcbiAgfVxuICAvL0NvbnRyb2xWYWx1ZUFjY2Vzc29yIC0gRU5EXG5cbiAgcHJpdmF0ZSBfaW50ZXJuYXRpb25hbEZvcm1hdCA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBnZXQgaW50ZXJuYXRpb25hbEZvcm1hdCgpIHtcbiAgICByZXR1cm4gdGhpcy5faW50ZXJuYXRpb25hbEZvcm1hdDtcbiAgfVxuICBzZXQgaW50ZXJuYXRpb25hbEZvcm1hdChmb3JtYXQpIHtcbiAgICB0aGlzLl9pbnRlcm5hdGlvbmFsRm9ybWF0ID0gY29lcmNlQm9vbGVhblByb3BlcnR5KGZvcm1hdCk7XG4gICAgdGhpcy5vbklucHV0Q2hhbmdlZCh0aGlzLnBob25lKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHVibGljIG5nQ29udHJvbDogTmdDb250cm9sLFxuICAgIHByaXZhdGUgZm06IEZvY3VzTW9uaXRvcixcbiAgICBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PixcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHsgXG4gICAgIGlmICh0aGlzLm5nQ29udHJvbCAhPSBudWxsKSB7XG4gICAgICAvLyBTZXR0aW5nIHRoZSB2YWx1ZSBhY2Nlc3NvciBkaXJlY3RseSAoaW5zdGVhZCBvZiB1c2luZ1xuICAgICAgLy8gdGhlIHByb3ZpZGVycykgdG8gYXZvaWQgcnVubmluZyBpbnRvIGEgY2lyY3VsYXIgaW1wb3J0LlxuICAgICAgdGhpcy5uZ0NvbnRyb2wudmFsdWVBY2Nlc3NvciA9IHRoaXM7XG4gICAgfVxuXG4gICAgZm0ubW9uaXRvcihlbFJlZi5uYXRpdmVFbGVtZW50LCB0cnVlKS5zdWJzY3JpYmUob3JpZ2luID0+IHtcbiAgICAgIHRoaXMuZm9jdXNlZCA9ICEhb3JpZ2luO1xuICAgICAgdGhpcy5zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICAgIH0pO1xuICB9XG5cbiAgLy9saWZlY3ljbGVcbiAgbmdPbkluaXQoKSB7XG4gICAgXG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmZtLnN0b3BNb25pdG9yaW5nKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCk7XG4gICAgdGhpcy5jb3VudHJ5Q2hhbmdlLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZXMuY29tcGxldGUoKTtcbiAgfVxuXG4gIG9uQ291bnRyeVNlbGVjdGVkKGNvZGU6IENvdW50cnlDb2RlLCBub1Bob25lUmVzZXQ/OiBib29sZWFuKSB7XG4gICAgbGV0IGhhc0NvdW50cnlDaGFuZ2VkID0gdGhpcy5zZWxlY3RlZENvdW50cnkgJiYgdGhpcy5zZWxlY3RlZENvdW50cnkgIT0gY29kZTtcbiAgICB0aGlzLnNlbGVjdGVkQ291bnRyeSA9IGNvZGU7XG5cbiAgICBsZXQgZXhhbXBsZSA9IGdldEV4YW1wbGVOdW1iZXIoY29kZSwgRXhhbXBsZXMpLmZvcm1hdE5hdGlvbmFsKCk7XG4gICAgbGV0IG51bWJlcnNPbmx5ID0gZXhhbXBsZS5yZXBsYWNlKC9bXlxcZF0vZywgJycpO1xuICAgIGxldCBtYXhFeGFtcGxlID0gbnVtYmVyc09ubHkgKyAnOTk5OTk5OTk5OSc7XG5cbiAgICB0aGlzLm1heElucHV0TGVuZ3RoID0gdGhpcy5QaG9uZU51bWJlck1heERpZ2l0cztcblxuICAgIC8vZmluZCBvdXQgdGhlIG1heGltdW0gKGZvcm1hdHRlZCkgc2l6ZSBhIHZhbGlkIG51bWJlciBmb3IgdGhlIGNvdW50cnkgY2FuIGhhdmVcbiAgICBmb3IgKGxldCBpID0gbWF4RXhhbXBsZS5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBsZXQgdGVzdCA9IG1heEV4YW1wbGUuc3Vic3RyaW5nKDAsIGkpO1xuICAgICAgbGV0IHRlc3RQaG9uZSA9IHBhcnNlUGhvbmVOdW1iZXJGcm9tU3RyaW5nKHRlc3QsIGNvZGUpO1xuXG4gICAgICBpZiAodGVzdFBob25lICYmIHRlc3RQaG9uZS5pc1ZhbGlkKCkpIHtcbiAgICAgICAgbGV0IG1heElucHV0ID0gbmV3IEFzWW91VHlwZShjb2RlKS5pbnB1dCh0ZXN0KTtcbiAgICAgICAgdGhpcy5tYXhJbnB1dExlbmd0aCA9IG1heElucHV0Lmxlbmd0aDtcbiAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG1heElucHV0Oy8vVE9ETyBzZXQgcGxhY2Vob2xkZXIgb3B0aW9uYWxseVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL3doZW4gbmV3IGNvdW50cnkgaXMgc2VsZWN0ZWQgcmVzZXQgcGhvbmUgaWYgcGhvbmUgcmVzZXQgd2FzIG5vdCBkaXNhYmxlZCBcbiAgICBpZiAoaGFzQ291bnRyeUNoYW5nZWQgJiYgIW5vUGhvbmVSZXNldCkge1xuICAgICAgdGhpcy5waG9uZSA9ICcnO1xuICAgICAgdGhpcy52YWx1ZSA9IHRoaXMucGhvbmU7XG5cbiAgICAgIC8vZm9jdXMgb24gaW5wdXRcbiAgICAgIGlmICh0aGlzLnBob25lSW5wdXQpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnBob25lSW5wdXQuZm9jdXMoKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25JbnB1dENoYW5nZWQoZTogc3RyaW5nKSB7XG4gICAgaWYgKCFlKSB7XG4gICAgICBlID0gJyc7XG4gICAgfVxuICAgIFxuICAgIHRoaXMucGhvbmUgPSBlO1xuXG4gICAgaWYgKGUuc3RhcnRzV2l0aCgnKycpKSB7Ly9oYW5kbGVzIHBhc3Rpbmcgb2YgYSBjb21wbGV0ZSBpbnRlcm5hdGlvbmFsIG51bWJlclxuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHBhc3RlZE51bWJlciAgPSBwYXJzZVBob25lTnVtYmVyRnJvbVN0cmluZyhlKTtcblxuICAgICAgICBpZiAocGFzdGVkTnVtYmVyICYmIHBhc3RlZE51bWJlci5jb3VudHJ5KSB7XG4gICAgICAgICAgbGV0IGNvZGUgPSBwYXN0ZWROdW1iZXIuY291bnRyeTtcbiAgICAgICAgICBcbiAgICAgICAgICB0aGlzLm9uQ291bnRyeVNlbGVjdGVkKGNvZGUsIHRydWUpO1xuXG4gICAgICAgICAgdGhpcy5jb3VudHJ5Q2hhbmdlLm5leHQoY29kZSk7XG5cbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucGhvbmUgPSBwYXN0ZWROdW1iZXIuZm9ybWF0TmF0aW9uYWwoKTtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnBob25lO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCB7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IG51bWJlcnNPbmx5ID0gZS5yZXBsYWNlKC9bXlxcZF0vZywgJycpO1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBsZXQgZm9ybWF0dGVkID0gbmV3IEFzWW91VHlwZSh0aGlzLnNlbGVjdGVkQ291bnRyeSkuaW5wdXQobnVtYmVyc09ubHkpO1xuICAgICAgLy9pZiB0aGUgZm9ybWF0dGVkIG91dHB1dCBlcXVhbHMgd2hhdCB3ZSBhbHJlYWR5IGhhdmUgdGhlbiB0aGUgdXNlciBpcyB0cnlpbmcgdG8gZGVsZXRlIGEgc3ltYm9sIGluc2VydGVkIGJ5XG4gICAgICAvL3RoZSBmb3JtYXR0ZWQgdmVyc2lvblxuICAgICAgdGhpcy5waG9uZSA9IGZvcm1hdHRlZC5zdWJzdHIoMCwgZm9ybWF0dGVkLmxlbmd0aCAtIDEpID09PSB0aGlzLnBob25lID8gbnVtYmVyc09ubHkgOiBmb3JtYXR0ZWQ7XG4gICAgICB0aGlzLnZhbHVlID0gdGhpcy5waG9uZTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIHB1YmxpYyBvbklucHV0S2V5UHJlc3MoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcblx0XHRjb25zdCBhbGxvd2VkQ2hhcnMgPSAvWzAtOVxcK1xcLVxcIF0vO1xuXHRcdGNvbnN0IGFsbG93ZWRDdHJsQ2hhcnMgPSAvW2F4Y3ZdLzsgLy8gQWxsb3dzIGNvcHktcGFzdGluZ1xuXHRcdGNvbnN0IGFsbG93ZWRPdGhlcktleXMgPSBbXG5cdFx0XHQnQXJyb3dMZWZ0JywgJ0Fycm93VXAnLCAnQXJyb3dSaWdodCcsICdBcnJvd0Rvd24nLFxuXHRcdFx0J0hvbWUnLCAnRW5kJywgJ0luc2VydCcsICdEZWxldGUnLCAnQmFja3NwYWNlJ1xuXHRcdF07XG5cblx0XHRpZiAoIWFsbG93ZWRDaGFycy50ZXN0KGV2ZW50LmtleSlcblx0XHRcdCYmICEoZXZlbnQuY3RybEtleSAmJiBhbGxvd2VkQ3RybENoYXJzLnRlc3QoZXZlbnQua2V5KSlcblx0XHRcdCYmICEoYWxsb3dlZE90aGVyS2V5cy5pbmNsdWRlcyhldmVudC5rZXkpKSkge1xuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG5cdH1cblxufVxuIl19